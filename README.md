# Setting up Debian/Ubuntu container pipeline
This project help create a jenkins server on a Debian/Ubuntu server.

## Before you begin
1. (Optional) If you want to make the server to be avaliable from the host network, in the `Vagrantfile` you must specify on what interface to expose them.

        config.vm.network "public_network", type: "dhcp", bridge: "interface_name"

2. Populate the `cluster.yaml` files whith the definition of all the servers you desire to have in the cluster.
    An example of a 3 servers configuration:

        severs:
          - ip: 192.168.56.10
            hostname: luke

          - ip: 192.168.56.20
            hostname: han

          - ip: 192.168.56.30
            hostname: leia

    `ip`: the ip assign to the VM on the private network created by the virtualizator.

    `hostname`: machine hostname

3. Have Ansible installed on the host machine.
    Also, install the Ansible role `nomad_consul_cluster`:

        ansible-galaxy install git+https://github.com/Mot93/nomad_consul_cluster.git

## Creating the VM
The VM can will be created by [Vagrant](https://www.vagrantup.com/).

In order to create and lauch the VM, use the following Vagrant command.

    vagrant up

Once done, destroy the vms:

    vagrant destroy

## Lauching ansible against the vagrant machines
Once the machines have been created, they have to be provvisioned.
The tool used by this example to setup the cluster is [Ansible](https://www.redhat.com/en/technologies/management/ansible).

### TIPS:
It's possible to relaunch the playbook `playbook.yml` against the machines made by Vagrant using an inventory autogenerated by Vagrant specifying the inventory path:

    ansible-playbook playbook.yml -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

To automate this process, it's possible to configure ansible via the `ansible.cfg` file.
To create the file: 

    ansible-config init --disabled > ansible.cfg

Configure the `ansible.cfg` file:

1. Set the inventory to the one generated by vagrant:

        inventory=./.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

2. Prevent ansuble from cheching the new VM ssh key:

        host_key_checking=False

3. Specify where the role folder is stored:
        
        roles_path=/path/to/role/

## Launching the docker-compose
Once the machine is ready, it's possible to launch the docker-compose on it

    ansible-playbook playbook-compose.yaml -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

## Compiling the container in the remote machine
Once the machine is ready, it's possible to compile the container on it

First create a file with all the necessary variables and specify it's location via the variable containers_config.
The file must contain the following entries:

    login: <boolean: wheter to login into the container registry>
    logout: <boolean: wheter to logout from the container registry>

    container_registry:
      server: <string: container registry login entrypoint>
      username: <string: container registry username>
      password: <string: container registry password>

    containers:
      - image:
          name: <string: name of the image>
          push: <boolean: whter to push it onto the container registry or not>
        dockerfile: 
          name: <string: the dockerfile name>
          location: <string: the dockerfile location>
          context: <string: the location of the Dockerfile contex>

The variable `containers` is a list of all the containers that have to be compiled, it's possible to add as many container as desired.

When the variable `push`is set to `true` either make sure that the target machine is logged into the container registry.
Alternatively the playbook can login into the container registry by setting the variable `login` to `true`.

If `logout` is set to `true`, after it's exexution, the playbook will logout from the container registry. Even if other taks fail, the logout will still be carried out.

To launch the playbook:

    ansible-playbook playbook-compile.yaml -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

## Hiding the container registry credentials
Create a file called `container_registry.enc` and populate it with the container credentials:

    container_registry:
      server: <container registry login entrypoint>
      username: <container registry username>
      password: <container registry password>

The default server for docker hub is: `https://index.docker.io/v1`

Encrypt the file:

    ansible-vault encrypt container_registry.enc

Use the encrypted file when launching the playbook:

    ansible-playbook playbook-compile.yaml -e @container_registry.enc --ask-vault-pass -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory
